name: ğŸš€ Despliegue de Angular on push

on:
  push:
    branches:
      - main # El flujo se ejecuta en cada push a la rama main

jobs:
  web-deploy:
    name: ğŸ‰ Despliegue
    runs-on: ubuntu-latest # Utiliza la Ãºltima versiÃ³n de Ubuntu para la ejecuciÃ³n

    steps:
      # Paso 1: Obtener el cÃ³digo mÃ¡s reciente del repositorio
      - name: ğŸšš Obtener el cÃ³digo mÃ¡s reciente
        uses: actions/checkout@v4

      # Paso 2: Configurar Node.js en la versiÃ³n especificada
      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18" # VersiÃ³n especÃ­fica de Node.js

      # Paso 3: Instalar dependencias y construir el proyecto Angular
      - name: ğŸ”§ Instalar dependencias y construir el proyecto
        run: |
          npm ci
          npx ng build --configuration=production

      # Paso 4: Crear el archivo .htaccess para configuraciones de Apache y PHP
      - name: ğŸ› ï¸ Crear archivo .htaccess
        run: |
          cat <<EOF > ./dist/angular-19-app/browser/.htaccess
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Redirige todas las solicitudes a index.html, excepto las solicitudes de archivos existentes
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^.*$ index.html [L]
          </IfModule>

            # ConfiguraciÃ³n de PHP
          <IfModule mod_php.c>
            php_value post_max_size 256M
            php_value upload_max_filesize 256M
            php_value max_execution_time 300
          </IfModule>
          EOF

      # Paso 5: Sincronizar los archivos generados con el servidor vÃ­a FTP
      - name: ğŸ“‚ Sincronizar archivos por FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: dev.imaarica.cl
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          local-dir: ./dist/angular-19-app/browser/
          server-dir: ./public_html/
          
      # Paso 6: NotificaciÃ³n en caso de que el despliegue falle
      - name: ğŸš¨ Notificar error en el despliegue
        if: failure()
        run: echo "El despliegue ha fallado ğŸ˜¢"
