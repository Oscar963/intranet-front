name: üöÄ Despliegue de Angular on push

on:
  push:
    branches:
      - main # El flujo se ejecuta en cada push a la rama main

jobs:
  web-deploy:
    name: üéâ Despliegue
    runs-on: ubuntu-latest # Utiliza la √∫ltima versi√≥n de Ubuntu para la ejecuci√≥n

    steps:
      # Paso 1: Obtener el c√≥digo m√°s reciente del repositorio
      - name: üöö Obtener el c√≥digo m√°s reciente
        uses: actions/checkout@v4

      # Paso 2: Configurar Node.js en la versi√≥n especificada
      - name: üîß Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18" # Versi√≥n espec√≠fica de Node.js

      # Paso 3: Instalar dependencias y construir el proyecto Angular
      - name: üîß Instalar dependencias y construir el proyecto
        run: |
          npm ci
          npx ng build --configuration=production

      # Paso 4: Crear el archivo .htaccess para configuraciones de Apache y PHP
      - name: üõ†Ô∏è Crear archivo .htaccess
        run: |
          cat <<EOF > ./dist/angular-19-app/browser/.htaccess
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
      
            # Redirige todas las solicitudes a index.html, excepto las solicitudes de archivos existentes
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^.*$ index.html [L]
          </IfModule>
      
          # Configuraci√≥n de PHP
          <IfModule mod_php.c>
            php_value post_max_size 256M
            php_value upload_max_filesize 256M
            php_value max_execution_time 300
            php_value memory_limit 128M
          </IfModule>
      
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/javascript application/json
          </IfModule>
      
          # üîí Restringir acceso solo a ciertas IPs
          <RequireAll>
            Require ip 152.230.211.90
            Require ip 152.230.211.158
            Require ip 152.230.214.48/28
            Require ip 152.230.211.91
            Require ip 152.230.211.191
            Require ip 152.230.211.192
            Require ip 152.230.211.69
            Require ip 152.230.211.71
            Require ip 152.230.211.167
            Require ip 152.230.211.101
            Require ip 152.230.211.96
            Require ip 152.230.211.105
            Require ip 152.230.211.110
            Require ip 152.230.211.112
            Require ip 152.230.211.144
            Require ip 152.230.211.201
            Require ip 152.230.211.151
            Require ip 152.230.211.181
            Require all denied
          </RequireAll>

          EOF

      # Paso 5: Sincronizar los archivos generados con el servidor v√≠a FTP
      - name: üìÇ Sincronizar archivos por FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: intranet.imaarica.cl
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/angular-19-app/browser/
          server-dir: ./public_html/

      # Paso 6: Notificar despliegue exitoso
      - name: ‚úÖ Notificar despliegue exitoso
        if: success()
        run: echo "El despliegue fue exitoso üöÄ"

      # Paso 7: Notificar error en el despliegue
      - name: üö® Notificar error en el despliegue
        if: failure()
        run:
          echo "El despliegue ha fallado üò¢"

          # üîÑ ¬øC√≥mo activar las extensiones PHP?
          # Si tu servidor es administrado (como en un hosting compartido), las opciones son:
          #
          # 1. Contactar al proveedor: Solicita que activen las extensiones necesarias.
          #
          # 2. Usar php.ini: Si te permiten usar un archivo php.ini personalizado, puedes intentar agregar:
          #
          # extension=mbstring
          # extension=intl
          # extension=bcmath
          # extension=pdo
          # extension=pdo_mysql
          #
          # Nota: La habilitaci√≥n de extensiones PHP depende del entorno del servidor.
